language: php

cache:
  directories:
    - $HOME/.composer/cache

before_install:
  - sudo apt update -qq
  - sudo apt install -y -qq postfix

install:
  - composer remove --no-update --no-scripts --dev phpdocumentor/phpdocumentor
  - composer install --no-interaction --prefer-source

before_script:
  - sudo service postfix stop
  - smtp-sink -d "%d.%H.%M.%S" localhost:2500 1000 &
  - mkdir -p build/logs
  - chmod +x scripts/fakesendmail.sh
  - sudo mkdir -p /var/qmail/bin
  - sudo cp scripts/fakesendmail.sh /var/qmail/bin/sendmail
  - sudo cp scripts/fakesendmail.sh /usr/sbin/sendmail
  - echo 'sendmail_path = "/usr/sbin/sendmail -t -i "' > $(php --ini|grep -m 1 "ini files in:"|cut -d ":" -f 2)/sendmail.ini

script: ./vendor/bin/phpunit --configuration ./travis.phpunit.xml.dist --coverage-clover clover.xml

after_script: bash <(curl -s https://codecov.io/bash)

stages:
  - coding-standard
  - test

jobs:
  include:
    - php: 7.2
    - php: 7.3
    - php: 7.4snapshot
    - php: nightly

matrix:
  allow_failures:
    - php: nightly
